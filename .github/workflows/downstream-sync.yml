name: Downstream Sync

on:
  repository_dispatch:
    types: [downstream-release]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Parse dispatch payload
        id: payload
        run: |
          echo "source=${{ github.event.client_payload.source }}" >> "$GITHUB_OUTPUT"
          echo "version=${{ github.event.client_payload.version }}" >> "$GITHUB_OUTPUT"
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: server
        run: npm ci

      - name: Validate distribution versions
        id: validate
        working-directory: server
        continue-on-error: true
        run: node scripts/validate-versions.js --distribution --skip-npm

      - name: Summary
        if: always()
        run: |
          echo "## Downstream Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | \`${{ steps.payload.outputs.source }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ steps.payload.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | ${{ steps.payload.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY
